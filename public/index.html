<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sistem Laporan Penjualan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{--primary:#2563eb;--bg:#f3f4f6;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--danger:#dc2626}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:420px;margin:60px auto;background:#fff;padding:30px;border-radius:14px;border:1px solid var(--border)}
h1{text-align:center;font-size:22px;margin:0 0 8px}
.subtitle{text-align:center;font-size:14px;color:var(--muted);margin-bottom:20px}
.meta{text-align:center;font-size:13px;color:var(--muted)}
input,button{width:100%;padding:13px;font-size:15px;border-radius:10px;margin-bottom:14px}
input{border:1px solid var(--border);text-transform:uppercase}
button{border:none;cursor:pointer;font-weight:600}
.btn-primary{background:var(--primary);color:#fff}
.btn-logout{background:#f9fafb;border:1px solid var(--border);color:var(--danger)}
.upload-box{border:2px dashed var(--border);border-radius:12px;padding:22px;text-align:center;cursor:pointer;color:var(--primary);font-weight:600;background:#f9fafb}
.upload-box input{display:none}
.total{text-align:center;margin-top:26px}
.total .label{font-size:13px;color:var(--muted)}
.total .value{font-size:32px;font-weight:700}
.spinner{width:36px;height:36px;border:4px solid #e5e7eb;border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:16px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.error{text-align:center;color:var(--danger);font-size:14px}
#uploadPage,#resultPage{display:none}
</style>
</head>

<body>

<div class="container" id="loginPage">
  <h1>Login Sistem</h1>
  <p class="subtitle">Masukkan akun terdaftar</p>
  <input id="username" placeholder="USERNAME">
  <input id="storeId" placeholder="KODE TOKO">
  <button class="btn-primary" onclick="login()">Masuk</button>
  <p class="error" id="error"></p>
</div>

<div class="container" id="uploadPage">
  <h1>Sistem Laporan Penjualan</h1>
  <div class="meta" id="welcomeText"></div>
  <div class="meta" id="todayText"></div>
  <div class="meta" id="expiredInfo"></div>

  <form id="form">
    <label class="upload-box">
      <input type="file" name="zipfile" accept=".zip" required id="zipInput">
      <span id="fileLabel">Upload File ZIP</span>
    </label>
    <button class="btn-primary">Proses</button>
  </form>

  <div id="uploadResult"></div>
  <button class="btn-logout" onclick="logout()">Logout</button>
</div>

<div class="container" id="resultPage">
  <h1 id="resultTitle"></h1>
  <div class="meta" id="resultDetail"></div>
  <div class="total">
    <div class="label">TOTAL SETORAN</div>
    <div class="value" id="totalValue">Rp 0</div>
  </div>
  <button class="btn-primary" onclick="uploadAgain()">Upload Lagi</button>
  <button class="btn-logout" onclick="logout()">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

/* ===== FIREBASE CONFIG (PUNYA KAMU) ===== */
const app = initializeApp({
  apiKey: "AIzaSyAvl_paDtkaHgPM2F1PRtybh_EanGfDT_Q",
  databaseURL: "https://serversetoran-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "serversetoran"
});
const db = getDatabase(app);

/* ===== DEVICE ID ===== */
function deviceId(){
  let d=localStorage.getItem("device_id");
  if(!d){
    d="DEV-"+btoa(navigator.userAgent+screen.width+screen.height).slice(0,20);
    localStorage.setItem("device_id",d);
  }
  return d;
}

const todayID=()=>new Date().toLocaleDateString("id-ID",{weekday:"long",day:"2-digit",month:"long",year:"numeric"});
const dateID=d=>new Date(d).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"});
let expiredDate="";

/* ===== LOGIN ===== */
window.login = async ()=>{
  const u=username.value.trim().toUpperCase();
  const s=storeId.value.trim().toUpperCase();
  if(!u||!s) return error.textContent="Data wajib diisi";

  const snap=await get(ref(db,"userList"));
  let key=null,user=null;

  snap.forEach(c=>{
    const v=c.val();
    if(v.username===u && v.storeId===s && v.active){
      key=c.key; user=v;
    }
  });

  if(!user) return error.textContent="Login tidak valid";

  const today=new Date().toISOString().split("T")[0];
  if(user.expired<today) return error.textContent="Akun sudah expired";

  const dev=deviceId();
  if(!user.deviceId){
    await update(ref(db,"userList/"+key),{deviceId:dev});
  } else if(user.deviceId!==dev){
    return error.textContent="Akun terkunci di device lain";
  }

  sessionStorage.setItem("login","1");
  sessionStorage.setItem("role",user.role);
  expiredDate=user.expired;
  showUpload();
};

function showUpload(){
  loginPage.style.display="none";
  uploadPage.style.display="block";
  welcomeText.textContent="Selamat datang, "+username.value;
  todayText.textContent="Tanggal: "+todayID();
  expiredInfo.textContent="Aktif s/d "+dateID(expiredDate);
}

form.onsubmit=async e=>{
  e.preventDefault();
  uploadResult.innerHTML=`<div class="spinner"></div>`;
  const fd=new FormData(form);
  fd.append("storeId",storeId.value);
  const r=await fetch("/api/upload",{method:"POST",body:fd});
  const j=await r.json();
  if(j.error) uploadResult.innerHTML=`<p class="error">${j.error}</p>`;
  else{
    uploadPage.style.display="none";
    resultPage.style.display="block";
    resultTitle.textContent=j.title;
    resultDetail.textContent=j.detail;
    totalValue.textContent="Rp "+j.hasil.toLocaleString("id-ID");
  }
};

window.uploadAgain=()=>{resultPage.style.display="none";uploadPage.style.display="block";};
window.logout=()=>{sessionStorage.clear();location.reload();};
</script>
</body>
</html>
